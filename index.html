<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000"/>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="EV Master">
	<link rel="apple-touch-icon" href="icon-192x192.png">
	<link rel="manifest" href="manifest.json">
    <title>EV Master</title>
    <style>
:root {
    --bg-dark: #020617; /* slate-950 */
    --bg-card: #0f172a; /* slate-900 */
    --border-color: #1e293b; /* slate-800 */
    --text-light: #e2e8f0; /* slate-200 */
    --text-muted: #64748b; /* slate-500 */
    --accent-blue: #60a5fa; /* blue-400 */
    --accent-emerald: #34d399; /* emerald-400 */
    --accent-red: #f87171; /* red-400 */
    --accent-amber: #fbbf24; /* amber-500 */
}

body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
    background-color: var(--bg-dark);
    color: var(--text-light);
    margin: 0;
    padding: 2rem;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
}

.container {
    width: 100%;
    max-width: 1024px;
}

header {
    text-align: center;
    margin-bottom: 2rem;
}

header h1 {
    font-size: 3rem;
    font-weight: 900;
    background: linear-gradient(to right, var(--accent-blue), var(--accent-emerald));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    margin: 0;
}

.grid-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
}

@media (min-width: 1024px) {
    .grid-container {
        grid-template-columns: 5fr 7fr;
        align-items: start;
    }
    header {
        text-align: left;
    }
}

.card {
    background-color: #0d1425e0;
    backdrop-filter: blur(20px);
    border: 1px solid var(--border-color);
    border-radius: 2rem;
    padding: 2rem;
    margin-bottom: 2rem;
}

.input-card {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.input-group label {
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--text-muted);
}

.input-wrapper {
    position: relative;
    display: flex;
}

.input-wrapper input[type="number"] {
    width: 100%;
    background-color: #1e293b80;
    border: 1px solid #334155;
    color: var(--text-light);
    border-radius: 0.75rem;
    padding: 0.75rem 1rem;
    font-size: 1.1rem;
    transition: all 0.2s;
}

.input-wrapper input[type="number"]:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.5);
    border-color: var(--accent-blue);
}

.input-wrapper span {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-weight: 700;
}

input[type="range"] {
    width: 100%;
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    background-color: #334155;
    border-radius: 3px;
    cursor: pointer;
    margin-top: 0.5rem;
}

input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background-color: var(--accent-blue);
    border: 3px solid var(--bg-card);
}

.results-card {
    text-align: center;
}

.battery-visual-container {
    position: relative;
    max-width: 280px;
    margin: 0 auto 2rem;
}

#battery-box {
    position: relative;
    height: 8rem;
    width: 100%;
    border: 4px solid var(--border-color);
    border-radius: 1rem;
    padding: 0.5rem;
    background-color: var(--bg-card);
    overflow: hidden;
}

#battery-level {
    height: 100%;
    border-radius: 0.5rem;
    transition: width 0.7s ease-out, background-color 0.7s ease-out;
    background-color: var(--accent-emerald);
}

#battery-tip {
    position: absolute;
    right: -12px;
    top: 50%;
    transform: translateY(-50%);
    width: 12px;
    height: 3rem;
    background-color: var(--border-color);
    border-top-right-radius: 0.25rem;
    border-bottom-right-radius: 0.25rem;
}

#battery-buffer-marker, #battery-start-marker {
    position: absolute;
    top: 0;
    bottom: 0;
    z-index: 10;
    transition: left 0.5s ease;
}

#battery-buffer-marker { border-left: 2px dashed var(--accent-red); }
#battery-start-marker { border-left: 2px dashed var(--accent-blue); }

#battery-buffer-marker span, #battery-start-marker span {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    font-weight: bold;
    text-transform: uppercase;
    white-space: nowrap;
}

#battery-buffer-marker span { top: -20px; color: var(--accent-red); }
#battery-start-marker span { bottom: -20px; color: var(--accent-blue); }

.battery-label span {
    font-size: 2.5rem;
    font-weight: 900;
}

.battery-label p {
    color: var(--text-muted);
    text-transform: uppercase;
    font-size: 0.9rem;
    letter-spacing: 0.1em;
    margin: 0;
}

.results-display h2 {
    color: var(--text-muted);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.9rem;
    letter-spacing: 0.05em;
}

.results-data .value {
    font-size: 6rem;
    font-weight: 900;
    line-height: 1;
}

.results-data .unit {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-muted);
    margin-left: 0.5rem;
    font-style: italic;
}

.details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border-color);
}

.details-item {
    background-color: #02061766;
    padding: 1rem;
    border-radius: 1rem;
    text-align: left;
}

.details-item .label {
    font-size: 10px;
    text-transform: uppercase;
    font-weight: 900;
    letter-spacing: 0.1em;
    color: var(--text-muted);
}

.details-item .value {
    font-size: 1.25rem;
    font-weight: 700;
}

.details-item .unit {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.stats-header {
    color: var(--text-muted);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.9rem;
    letter-spacing: 0.05em;
    border-top: 1px solid var(--border-color);
    padding-top: 2rem;
}

.value.blue { color: var(--accent-blue); }
.value.green { color: var(--accent-emerald); }
.value.yellow { color: var(--accent-amber); }
.value.red { color: var(--accent-red); }

.no-results {
    padding: 2rem 1rem;
    background-color: #1e293b33;
    border-radius: 1rem;
    border: 1px dashed var(--border-color);
    color: var(--text-muted);
}

/* Calculator Styles */
.calculator-section {
    grid-column: 1 / -1;
}

.calc-container {
    display: grid;
    grid-template-columns: 1.2fr 1fr;
    gap: 2rem;
}

@media (max-width: 768px) {
    .calc-container {
        grid-template-columns: 1fr;
    }
}

.calc-display {
    background: #1e293b80;
    padding: 1rem;
    border-radius: 0.75rem;
    text-align: right;
    margin-bottom: 1rem;
    border: 1px solid var(--border-color);
}

.calc-display .operation {
    font-size: 0.9rem;
    color: var(--text-muted);
    min-height: 1.2rem;
    word-break: break-all;
}

.calc-display .current {
    font-size: 2rem;
    font-weight: 900;
    color: var(--text-light);
    overflow: hidden;
}

.calc-buttons {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
}

.btn {
    padding: 1.2rem;
    border-radius: 0.75rem;
    border: 1px solid var(--border-color);
    background: var(--bg-card);
    color: var(--text-light);
    font-size: 1.2rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
}

.btn:hover { background: #1e293b; }
.btn:active { transform: scale(0.95); }
.btn-accent { background: var(--accent-blue); color: var(--bg-dark); }
.btn-accent:hover { background: #93c5fd; }
.btn-op { color: var(--accent-amber); }

.tape-container {
    background: #02061780;
    border-radius: 1rem;
    padding: 1rem;
    border: 1px solid var(--border-color);
    max-height: 450px;
    display: flex;
    flex-direction: column;
}

.tape-title {
    font-size: 0.8rem;
    font-weight: 900;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 0.5rem;
}

#calc-tape {
    overflow-y: auto;
    flex-grow: 1;
    display: flex;
    flex-direction: column-reverse;
    gap: 0.75rem;
}

.tape-entry {
    font-family: 'Courier New', Courier, monospace;
    font-size: 0.9rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #1e293b44;
}

.tape-entry .expr { color: var(--text-muted); }
.tape-entry .res { color: var(--accent-emerald); font-weight: bold; font-size: 1.1rem; }

/* Tab Styles */
.tab-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}
.tab-btn {
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    border: none;
    border-bottom: 2px solid transparent;
    border-radius: 0.5rem 0.5rem 0 0;
    background: none;
    color: var(--text-muted);
    font-weight: 700;
    transition: all 0.2s;
    font-size: 1rem;
}
.tab-btn:hover {
    background-color: var(--bg-card);
    color: var(--text-light);
}
.tab-btn.active {
    color: var(--accent-blue);
    border-bottom-color: var(--accent-blue);
}
.tab-content {
    display: none;
    animation: fadeIn 0.5s;
}
.tab-content.active {
    display: block;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>EV MASTER</h1>
        </header>


        <main>
            <div class="card input-card">
                    <div class="presets-container" style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);">
                        <select id="vehiclePresets" style="width: 100%; background-color: #1e293b80; border: 1px solid #334155; color: var(--text-light); border-radius: 0.75rem; padding: 0.75rem 1rem; font-size: 1rem;"></select>
                        <button id="savePresetBtn" class="btn" style="padding: 0.75rem 1rem; white-space: nowrap;">Save As</button>
                        <button id="deletePresetBtn" class="btn btn-op" style="padding: 0.75rem 1rem;">Delete</button>
                    </div>
                    <div class="input-group">
                        <label for="startBattery">Starting battery %</label>
                        <div class="input-wrapper">
                            <input type="number" id="startBattery" value="100" min="0" max="100">
                            <span>%</span>
                        </div>
                        <input type="range" id="startBatteryRange" value="100" min="0" max="100">
                    </div>
                    <div class="input-group">
                        <label for="currentBattery">Current battery %</label>
                        <div class="input-wrapper">
                            <input type="number" id="currentBattery" value="80" min="0" max="100">
                            <span>%</span>
                        </div>
                        <input type="range" id="currentBatteryRange" value="80" min="0" max="100">
                    </div>
                    <div class="input-group">
                        <label for="kilometersTraveled">Traveled Km</label>
                        <div class="input-wrapper">
                            <input type="number" id="kilometersTraveled" value="50" min="0" max="500">
                            <span>Km</span>
                        </div>
                        <input type="range" id="kilometersTraveledRange" value="50" min="0" max="500">
                    </div>
                    <div class="input-group">
                        <label for="minBattery">Minimum battery % limit</label>
                        <div class="input-wrapper">
                            <input type="number" id="minBattery" value="10" min="0" max="100">
                            <span>%</span>
                        </div>
                        <input type="range" id="minBatteryRange" value="10" min="0" max="100">
                    </div>
                    <div class="input-group">
                        <label for="capacitaBatteria">Battery usable kWh capacity</label>
                        <div class="input-wrapper">
                            <input type="number" id="capacitaBatteria" value="75" min="10" max="150">
                            <span>kWh</span>
                        </div>
                        <input type="range" id="capacitaBatteriaRange" value="75" min="10" max="150">
                    </div>
                    <div class="input-group">
                        <label for="costoKwh">Per unit kWh price</label>
                        <div class="input-wrapper">
                            <input type="number" id="costoKwh" value="0.25" min="0.01" max="1.50" step="0.01">
                            <span>€/kWh</span>
                        </div>
                        <input type="range" id="costoKwhRange" value="0.25" min="0.01" max="1.50" step="0.01">
                    </div>
                    <div class="input-group">
                        <label for="costoBenzina">Per unit fuel price</label>
                        <div class="input-wrapper">
                            <input type="number" id="costoBenzina" value="1.70" min="1.00" max="3.00" step="0.01">
                            <span>€/L</span>
                        </div>
                        <input type="range" id="costoBenzinaRange" value="1.70" min="1.00" max="3.00" step="0.01">
                    </div>
                    <div class="input-group">
                        <label for="consumoBenzina">ICE fuel consumption</label>
                        <div class="input-wrapper">
                            <input type="number" id="consumoBenzina" value="15" min="5" max="40" step="0.5">
                            <span>Km/L</span>
                        </div>
                        <input type="range" id="consumoBenzinaRange" value="15" min="5" max="40" step="0.5">
                    </div>
                </div>
            

            <div class="tab-nav">
                <button class="tab-btn active" data-tab="stats">Statistics</button>
                <button class="tab-btn" data-tab="autonomy">Residual Autonomy</button>
                <button class="tab-btn" data-tab="estimator">Trip Estimator</button>
                <button class="tab-btn" data-tab="charging">Charging Calculator</button>
                <button class="tab-btn" data-tab="quick-calc">Calculator</button>
            </div>

            <div class="tab-content-container">
                <div id="tab-stats" class="tab-content active">
                    <div class="card">
                        <h3 class="stats-header" style="border:none; padding-top:0; margin-bottom: 1.5rem;">Travel and consumption Statistics</h3>
                        <div id="stats-grid" class="details-grid"></div>
                    </div>
                </div>

                <div id="tab-autonomy" class="tab-content">
                    <div class="card results-card">
                        <div class="battery-visual-container">
                            <div id="battery-tip"></div>
                            <div id="battery-box">
                                <div id="battery-level"></div>
                                <div id="battery-buffer-marker"><span>Buffer</span></div>
                                <div id="battery-start-marker"><span>Start</span></div>
                            </div>
                            <div class="battery-label">
                                <span id="battery-percentage-label">80%</span>
                                <p>Current charge</p>
                            </div>
                        </div>
        
                        <div class="results-display">
                            <h2>Expected residual autonomy</h2>
                            <div id="results-content"></div>
                        </div>
                    </div>
                </div>

                <div id="tab-estimator" class="tab-content">
                    <div class="card" id="trip-estimator-card">
                        <h3 class="stats-header" style="border:none; padding-top:0; margin-bottom: 1.5rem;">Trip Consumption Estimator</h3>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: -1rem; margin-bottom: 1rem; text-align: left;">
                            Estimates a future trip based on the <strong style="color: var(--accent-red);">real consumption</strong> calculated from your last drive.
                        </p>
                        <div class="input-group">
                            <label for="tripDistance">Trip Distance (Km)</label>
                            <div class="input-wrapper"><input type="number" id="tripDistance" value="100" min="0" max="1000"><span>Km</span></div>
                        </div>
                        <div class="input-group">
                            <label for="externalTemp">External Temperature (°C)</label>
                            <div class="input-wrapper"><input type="number" id="externalTemp" value="20" min="-20" max="40"><span>°C</span></div>
                        </div>
                        <div class="input-group">
                            <label for="averageSpeed">Average Speed (Km/h)</label>
                            <div class="input-wrapper"><input type="number" id="averageSpeed" value="90" min="30" max="140"><span>Km/h</span></div>
                        </div>
                        <div class="input-group">
                             <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 1rem; color: var(--text-light);"><input type="checkbox" id="useHeatingAc" style="width: 1.2rem; height: 1.2rem;"> Use Heating / AC</label>
                        </div>
                        <div id="trip-estimator-results" class="details-grid" style="margin-top: 1.5rem; grid-template-columns: 1fr 1fr;"></div>
                    </div>
                </div>

                <div id="tab-charging" class="tab-content">
                    <div class="card" id="charging-calculator-card">
                        <h3 class="stats-header" style="border:none; padding-top:0; margin-bottom: 1.5rem;">Charging Calculator</h3>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: -1rem; margin-bottom: 1rem; text-align: left;">
                            Calculates charging time and cost. Doesn't account for charging curve (assumes linear speed).
                        </p>
                         <div class="input-group">
                            <label for="chargePower">Charging Power (kW)</label>
                            <div class="input-wrapper"><input type="number" id="chargePower" value="11" min="1" max="350"><span>kW</span></div>
                        </div>
                        <div class="input-group">
                            <label for="chargeStartSoc">Starting SOC (%)</label>
                            <div class="input-wrapper"><input type="number" id="chargeStartSoc" value="20" min="0" max="100"><span>%</span></div>
                        </div>
                        <div class="input-group">
                            <label for="chargeTargetSoc">Target SOC (%)</label>
                            <div class="input-wrapper"><input type="number" id="chargeTargetSoc" value="80" min="0" max="100"><span>%</span></div>
                        </div>
                        <div id="charging-calculator-results" class="details-grid" style="margin-top: 1.5rem;"></div>
                    </div>
                </div>

                <div id="tab-quick-calc" class="tab-content">
                    <div class="card calculator-section">
                        <h3 class="stats-header" style="border:none; padding-top:0; margin-bottom: 1.5rem;">Quick calculator</h3>
                        <div class="calc-container">
                            <div class="calc-main">
                                <div class="calc-display">
                                    <div class="operation" id="calc-op"></div>
                                    <div class="current" id="calc-current">0</div>
                                </div>
                                <div class="calc-buttons">
                                    <button class="btn btn-op" onclick="calcAction('C')">C</button>
                                    <button class="btn btn-op" onclick="calcAction('(')">(</button>
                                    <button class="btn btn-op" onclick="calcAction(')')">)</button>
                                    <button class="btn btn-op" onclick="calcAction('DEL')">←</button>
                                    
                                    <button class="btn" onclick="calcAction('7')">7</button>
                                    <button class="btn" onclick="calcAction('8')">8</button>
                                    <button class="btn" onclick="calcAction('9')">9</button>
                                    <button class="btn btn-op" onclick="calcAction('/')">÷</button>
                                    
                                    <button class="btn" onclick="calcAction('4')">4</button>
                                    <button class="btn" onclick="calcAction('5')">5</button>
                                    <button class="btn" onclick="calcAction('6')">6</button>
                                    <button class="btn btn-op" onclick="calcAction('*')">×</button>
                                    
                                    <button class="btn" onclick="calcAction('1')">1</button>
                                    <button class="btn" onclick="calcAction('2')">2</button>
                                    <button class="btn" onclick="calcAction('3')">3</button>
                                    <button class="btn btn-op" onclick="calcAction('-')">-</button>
                                    
                                    <button class="btn" style="grid-column: span 1;" onclick="calcAction('0')">0</button>
                                    <button class="btn" onclick="calcAction('.')">.</button>
                                    <button class="btn btn-accent" onclick="calcAction('=')">=</button>
                                    <button class="btn btn-op" onclick="calcAction('+')">+</button>
                                </div>
                            </div>
                            <div class="tape-container">
                                <div class="tape-title">Computation chronology</div>
                                <div id="calc-tape">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT ---
    const state = {
        // Main calculator
        startBattery: 100, currentBattery: 80, kilometersTraveled: 50, minBattery: 10,
        capacitaBatteria: 75, costoKwh: 0.25, costoBenzina: 1.70, consumoBenzina: 15,
        // Vehicle presets
        presets: {}, selectedPreset: null,
        // Trip estimator
        tripDistance: 100, externalTemp: 20, averageSpeed: 90, useHeatingAc: false,
        // Charging calculator
        chargePower: 11, chargeStartSoc: 20, chargeTargetSoc: 80,
    };
    let baselineConsumption = null; // Stores kWh/100km from main calculator

    // --- DOM ELEMENT SELECTORS ---
    const DOMElements = {
        inputs: {
            startBattery: document.getElementById('startBattery'), currentBattery: document.getElementById('currentBattery'),
            kilometersTraveled: document.getElementById('kilometersTraveled'), minBattery: document.getElementById('minBattery'),
            capacitaBatteria: document.getElementById('capacitaBatteria'), costoKwh: document.getElementById('costoKwh'),
            costoBenzina: document.getElementById('costoBenzina'), consumoBenzina: document.getElementById('consumoBenzina'),
            tripDistance: document.getElementById('tripDistance'), externalTemp: document.getElementById('externalTemp'),
            averageSpeed: document.getElementById('averageSpeed'), useHeatingAc: document.getElementById('useHeatingAc'),
            chargePower: document.getElementById('chargePower'), chargeStartSoc: document.getElementById('chargeStartSoc'),
            chargeTargetSoc: document.getElementById('chargeTargetSoc'),
        },
        ranges: {
            startBattery: document.getElementById('startBatteryRange'), currentBattery: document.getElementById('currentBatteryRange'),
            kilometersTraveled: document.getElementById('kilometersTraveledRange'), minBattery: document.getElementById('minBatteryRange'),
            capacitaBatteria: document.getElementById('capacitaBatteriaRange'), costoKwh: document.getElementById('costoKwhRange'),
            costoBenzina: document.getElementById('costoBenzinaRange'), consumoBenzina: document.getElementById('consumoBenzinaRange'),
        },
        battery: {
            level: document.getElementById('battery-level'), percentageLabel: document.getElementById('battery-percentage-label'),
            bufferMarker: document.getElementById('battery-buffer-marker'), startMarker: document.getElementById('battery-start-marker'),
        },
        presets: {
            select: document.getElementById('vehiclePresets'),
            saveBtn: document.getElementById('savePresetBtn'),
            deleteBtn: document.getElementById('deletePresetBtn'),
        },
        results: {
            main: document.getElementById('results-content'),
            stats: document.getElementById('stats-grid'),
            estimator: document.getElementById('trip-estimator-results'),
            charging: document.getElementById('charging-calculator-results'),
        }
    };

    // --- LOCAL STORAGE ---
    const saveState = () => localStorage.setItem('evMasterState', JSON.stringify(state));
    const loadState = () => {
        const saved = localStorage.getItem('evMasterState');
        if (saved) {
            const loadedState = JSON.parse(saved);
            // Ensure presets are not overwritten if they don't exist in old saves
            if (!loadedState.presets) loadedState.presets = {};
            Object.assign(state, loadedState);
        }
    };
    
    // --- PRESET MANAGEMENT ---
    const initPresets = () => {
        const { select, saveBtn, deleteBtn } = DOMElements.presets;
        select.innerHTML = '<option value="">Select a vehicle profile...</option>';
        for (const name in state.presets) {
            const option = new Option(name, name, false, name === state.selectedPreset);
            select.add(option);
        }
        select.addEventListener('change', (e) => applyPreset(e.target.value));
        saveBtn.addEventListener('click', savePreset);
        deleteBtn.addEventListener('click', deletePreset);
    };

    const savePreset = () => {
        const name = prompt('Enter a name for this vehicle profile:');
        if (name && name.trim()) {
            state.presets[name.trim()] = {
                capacitaBatteria: state.capacitaBatteria,
                consumoBenzina: state.consumoBenzina, // Example of another vehicle-specific param
            };
            state.selectedPreset = name.trim();
            initPresets();
            saveState();
        }
    };
    
    const applyPreset = (name) => {
        if (name && state.presets[name]) {
            const preset = state.presets[name];
            state.capacitaBatteria = preset.capacitaBatteria;
            state.consumoBenzina = preset.consumoBenzina;
            state.selectedPreset = name;
            updateUI();
            saveState();
            bindInputsToState(); // Re-sync inputs
        }
    };

    const deletePreset = () => {
        const name = DOMElements.presets.select.value;
        if (name && confirm(`Are you sure you want to delete the profile "${name}"?`)) {
            delete state.presets[name];
            state.selectedPreset = null;
            initPresets();
            saveState();
        }
    };

    // --- CALCULATORS ---
    const calculateMainResults = () => {
        const { startBattery, currentBattery, kilometersTraveled, minBattery, capacitaBatteria, costoKwh, costoBenzina, consumoBenzina } = state;
        if (startBattery <= currentBattery || kilometersTraveled <= 0 || capacitaBatteria <= 0) {
            baselineConsumption = null; return null;
        }

        const usedPercentage = startBattery - currentBattery;
        const kmPerPercent = kilometersTraveled / usedPercentage;
        const usableRemainingPercentage = Math.max(0, currentBattery - minBattery);
        const remainingRange = usableRemainingPercentage * kmPerPercent;
        const energyUsedKwh = (usedPercentage / 100) * capacitaBatteria;
        const consumptionKwh100km = (energyUsedKwh / kilometersTraveled) * 100;
        
        baselineConsumption = consumptionKwh100km; // Store for estimator

        const efficiencyKmKwh = kilometersTraveled / energyUsedKwh;
        const tripCost = energyUsedKwh * costoKwh;
        return {
            remainingRange, kmPerPercent, consumptionKwh100km, efficiencyKmKwh, tripCost, energyUsedKwh,
            energyAtMinBuffer: (minBattery / 100) * capacitaBatteria,
            costPerKm: tripCost / kilometersTraveled,
            iceEquivalentKm: (costoBenzina > 0 && consumoBenzina > 0) ? (tripCost / costoBenzina) * consumoBenzina : 0,
            equivalentEfficiency: (costoKwh > 0 && isFinite(efficiencyKmKwh)) ? (costoBenzina / costoKwh) * efficiencyKmKwh : 0,
        };
    };

    const calculateTripEstimation = () => {
        if (!baselineConsumption) return null;

        const { tripDistance, externalTemp, averageSpeed, useHeatingAc, capacitaBatteria, currentBattery } = state;
        
        // Simplified adjustment factors
        const tempFactor = externalTemp < 20 ? 1 + (20 - externalTemp) * 0.015 : 1 - (externalTemp - 20) * 0.005;
        const speedFactor = averageSpeed > 90 ? 1 + Math.pow((averageSpeed - 90) / 50, 2) : 1 - Math.pow((90 - averageSpeed) / 100, 1.5);
        const heatingFactor = useHeatingAc ? 1.15 : 1; // 15% penalty for AC/Heating
        
        const adjustedConsumption = baselineConsumption * tempFactor * speedFactor * heatingFactor;
        const estimatedKwh = adjustedConsumption * (tripDistance / 100);
        const socUsed = (estimatedKwh / capacitaBatteria) * 100;
        
        return {
            adjustedConsumption: adjustedConsumption.toFixed(2),
            estimatedKwh: estimatedKwh.toFixed(2),
            socUsed: socUsed.toFixed(1),
            finalSoc: (currentBattery - socUsed).toFixed(1),
        };
    };

    const calculateCharging = () => {
        const { chargeStartSoc, chargeTargetSoc, chargePower, capacitaBatteria, costoKwh } = state;
        if (chargeTargetSoc <= chargeStartSoc || chargePower <= 0) return null;

        const kwhNeeded = ((chargeTargetSoc - chargeStartSoc) / 100) * capacitaBatteria;
        const timeHours = kwhNeeded / chargePower;
        const totalMinutes = Math.round(timeHours * 60);
        const hours = Math.floor(totalMinutes / 60);
        const minutes = totalMinutes % 60;

        return {
            kwhAdded: kwhNeeded.toFixed(2),
            cost: (kwhNeeded * costoKwh).toFixed(2),
            time: `${hours}h ${minutes}m`,
        };
    };

    // --- UI UPDATES ---
    const updateUI = () => {
        // Main Results
        const { currentBattery, minBattery, startBattery } = state;
        DOMElements.battery.level.style.width = `${currentBattery}%`;
        let color = currentBattery <= minBattery ? 'var(--accent-red)' : (currentBattery <= 20 ? 'var(--accent-amber)' : 'var(--accent-emerald)');
        DOMElements.battery.level.style.backgroundColor = color;
        DOMElements.battery.percentageLabel.innerText = `${currentBattery}%`;
        DOMElements.battery.bufferMarker.style.left = `${minBattery}%`;
        DOMElements.battery.startMarker.style.left = `${startBattery}%`;

        const res = calculateMainResults();
        if (res) {
            DOMElements.results.main.innerHTML = `<div class="results-data"><span class="value">${Math.round(res.remainingRange)}</span><span class="unit">Km</span></div>`;
            DOMElements.results.stats.innerHTML = `
                <div class="details-item"><p class="label">Drive consumption</p><p class="value red">${res.consumptionKwh100km.toFixed(2)} <span class="unit">kWh/100Km</span></p></div>
                <div class="details-item"><p class="label">kWh Consumed</p><p class="value red">${res.energyUsedKwh.toFixed(2)} <span class="unit">kWh</span></p></div>
                <div class="details-item"><p class="label">Residual kWh at minimum %</p><p class="value green">${res.energyAtMinBuffer.toFixed(2)} <span class="unit">kWh</span></p></div>
                <div class="details-item"><p class="label">BEV efficiency</p><p class="value blue">${res.efficiencyKmKwh.toFixed(2)} <span class="unit">Km/kWh</span></p></div>
                <div class="details-item"><p class="label">Drive cost</p><p class="value yellow">${res.tripCost.toFixed(2)} <span class="unit">€</span></p></div>
                <div class="details-item"><p class="label">Drive cost per Km</p><p class="value yellow">${res.costPerKm.toFixed(3)} <span class="unit">€/Km</span></p></div>
                <div class="details-item"><p class="label">Equivalent ICE efficiency</p><p class="value blue">${res.equivalentEfficiency.toFixed(1)} <span class="unit">Km/L</span></p></div>
                <div class="details-item"><p class="label">Equivalent ICE distance</p><p class="value blue">${res.iceEquivalentKm.toFixed(1)} <span class="unit">Km</span></p></div>
                <div class="details-item"><p class="label">Km per %</p><p class="value white">${res.kmPerPercent.toFixed(2)} <span class="unit">Km</span></p></div>`;
        } else {
            DOMElements.results.main.innerHTML = `<div class="no-results"><p>Enter valid data (Start % > Current %)</p></div>`;
            DOMElements.results.stats.innerHTML = '';
        }
        
        // Update other calculators that depend on main results
        updateTripEstimatorUI();
        updateChargingCalculatorUI();
    };
    
    const updateTripEstimatorUI = () => {
        const res = calculateTripEstimation();
        if(res) {
            DOMElements.results.estimator.innerHTML = `
                <div class="details-item"><p class="label">Adjusted Consumption</p><p class="value red">${res.adjustedConsumption} <span class="unit">kWh/100km</span></p></div>
                <div class="details-item"><p class="label">Estimated kWh needed</p><p class="value red">${res.estimatedKwh} <span class="unit">kWh</span></p></div>
                <div class="details-item"><p class="label">SOC% Used</p><p class="value yellow">${res.socUsed} <span class="unit">%</span></p></div>
                <div class="details-item"><p class="label">Est. Final SOC</p><p class="value green">${res.finalSoc} <span class="unit">%</span></p></div>`;
        } else {
            DOMElements.results.estimator.innerHTML = `<div class="no-results" style="grid-column: 1 / -1;"><p>Calculate real consumption first by filling the main form.</p></div>`;
        }
    };

    const updateChargingCalculatorUI = () => {
        const res = calculateCharging();
        if (res) {
             DOMElements.results.charging.innerHTML = `
                <div class="details-item"><p class="label">Time</p><p class="value blue">${res.time} <span class="unit"></span></p></div>
                <div class="details-item"><p class="label">Energy Added</p><p class="value green">${res.kwhAdded} <span class="unit">kWh</span></p></div>
                <div class="details-item"><p class="label">Cost</p><p class="value yellow">${res.cost} <span class="unit">€</span></p></div>`;
        } else {
             DOMElements.results.charging.innerHTML = `<div class="no-results" style="grid-column: 1 / -1;"><p>Enter valid data (Target % > Start %)</p></div>`;
        }
    };

    // --- BINDING AND INITIALIZATION ---
    const bindInputsToState = () => {
        // Bind main form inputs
        Object.keys(DOMElements.inputs).forEach(key => {
            const input = DOMElements.inputs[key];
            if (!input) return;

            const update = (e) => {
                const value = e.target.type === 'checkbox' ? e.target.checked : Number(e.target.value);
                state[key] = value;
                if (DOMElements.inputs[key]) DOMElements.inputs[key].value = value;
                if (DOMElements.ranges[key]) DOMElements.ranges[key].value = value;
                updateUI();
                saveState();
            };

            input.addEventListener('input', update);
            if (DOMElements.ranges[key]) {
                DOMElements.ranges[key].addEventListener('input', update);
            }
        });
    };
    
    const syncStateToInputs = () => {
         Object.keys(state).forEach(key => {
            if (DOMElements.inputs[key]) {
                const el = DOMElements.inputs[key];
                if (el.type === 'checkbox') el.checked = state[key];
                else el.value = state[key];
            }
            if (DOMElements.ranges[key]) DOMElements.ranges[key].value = state[key];
        });
    };

    // Initial Load
    loadState();
    initPresets();
    syncStateToInputs();
    bindInputsToState();
    updateUI();

    // --- TAB NAVIGATION ---
    const initTabs = () => {
        const tabContainer = document.querySelector('.tab-nav');
        if (!tabContainer) return;
        
        tabContainer.addEventListener('click', (e) => {
            const clickedTab = e.target.closest('.tab-btn');
            if (!clickedTab) return;

            if (clickedTab.classList.contains('active')) return;

            // Deactivate all tabs and content
            tabContainer.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Activate clicked tab and its content
            clickedTab.classList.add('active');
            const targetContent = document.getElementById('tab-' + clickedTab.dataset.tab);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        });
    };

    initTabs();
});

// --- STANDALONE QUICK CALCULATOR LOGIC ---
let expression = '';
let shouldResetDisplay = false;

function calcAction(val) {
    const currentDisplay = document.getElementById('calc-current');
    const opDisplay = document.getElementById('calc-op');
    const tape = document.getElementById('calc-tape');

    if (val === 'C') {
        expression = '';
        currentDisplay.innerText = '0';
        opDisplay.innerText = '';
    } 
    else if (val === 'DEL') {
        expression = expression.trim().slice(0, -1);
        currentDisplay.innerText = expression || '0';
    } 
    else if (val === '=') {
        try {
            if (!expression) return;
            let finalExpr = expression.replace(/×/g, '*').replace(/÷/g, '/');
            let result = new Function('return ' + finalExpr)();
            if (typeof result === 'number') {
                result = Math.round((result + Number.EPSILON) * 1000) / 1000;
            }

            const entry = document.createElement('div');
            entry.className = 'tape-entry';
            entry.innerHTML = `<div class="expr">${expression} =</div><div class="res">${result}</div>`;
            tape.prepend(entry);

            opDisplay.innerText = expression + ' =';
            currentDisplay.innerText = result;
            expression = result.toString();
            shouldResetDisplay = true;

        } catch (e) {
            currentDisplay.innerText = 'Error';
            expression = '';
        }
    } 
    else {
        if (shouldResetDisplay) {
            if (/[0-9(]/.test(val)) expression = '';
            shouldResetDisplay = false;
        }
        let visualVal = val;
        if (val === '*') visualVal = ' × ';
        if (val === '/') visualVal = ' ÷ ';
        if (['+', '-'].includes(val)) visualVal = ` ${val} `;
        expression += visualVal;
        currentDisplay.innerText = expression;
    }
}
    </script>
	<script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/sw.js').then(function(registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, function(err) {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>

</body>
</html>
